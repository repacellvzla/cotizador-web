<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>CotizaciÃ³n - La Quincalla de Mauriel</title>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>

    <style>
        /* Estilos CSS (Sin cambios) */
        :root{--azul:#007bff;--gris:#f4f7f6;--border-color:#ccc}
        body{font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Helvetica,Arial,sans-serif;background:var(--gris);margin:0;padding:20px;color:#333}
        
        .controles{background:#fff;padding:14px;border-radius:8px;box-shadow:0 4px 12px rgba(0,0,0,.05);text-align:center;margin-bottom:18px}
        .btn{background:var(--azul);color:#fff;padding:10px 18px;border:0;border-radius:6px;cursor:pointer;margin:0 6px}
        .btn-secundario{background:#28a745}
        .btn-peligro{background:#dc3545;padding:6px 8px;border-radius:6px;font-size:12px}

        .cotizacion-container{
            width:8.5in; 
            min-height:11in; 
            margin:0 auto; 
            background:#fff; 
            border:1px solid #e6e6e6; 
            padding:36px 44px; 
            box-shadow:0 0 15px rgba(0,0,0,.08); 
            position:relative; 
            box-sizing:border-box
        }
        
        .header table{width:100%}
        #logo-web{max-width:120px; height:auto; display:block;}
        .empresa-info{text-align:right}
        .header h1{color:var(--azul);margin:0 0 6px;font-size:26px}
        
        .info-section{display:flex;gap:30px;margin-top:24px}
        .info-section > div{flex:1; padding: 8px; border: 1px solid var(--border-color); border-radius: 4px;} 
        .info-section h3{margin-top:0; border-bottom: 2px solid var(--azul); padding-bottom: 4px; font-size: 16px; margin-bottom: 12px;}
        .info-item{display:flex;align-items:center;margin-bottom:6px; font-size: 13px;}
        .info-item label{width:100px;font-weight:600;margin-right:8px}
        .info-section .cot-data label {width: auto; min-width: 80px;} 
        
        /* =============================================
           âœ… CORRECCIÃ“N 1: ALINEACIÃ“N
           Se eliminÃ³ la regla 'justify-content: flex-end;' de la siguiente clase
           para que la columna de cotizaciÃ³n se alinee a la izquierda.
           =============================================
        */
        .info-section .cot-data .info-item { /* justify-content: flex-end; <-- SE ELIMINÃ“ ESTO */ } 
        
        .info-item input{padding:4px 6px;border:1px solid #e6e6e6;border-radius:4px;font-size:13px}
        /* El textarea tiene una altura mÃ­nima en la web */
        .info-item textarea{flex:1;padding:4px 6px;border:1px solid #e6e6e6;border-radius:4px;font-size:13px; min-height:50px;}
        
        table#tabla-items{width:100%;margin-top:24px;border-collapse:collapse; font-size: 13px;}
        #tabla-items th,#tabla-items td{border:1px solid #e6e6e6;padding:8px;text-align:left} 
        #tabla-items th{background:#f0f0f0; font-size: 14px;}
        #tabla-items input{width:100%;box-sizing:border-box;padding:4px;border:1px solid #ccd; font-size: 13px;} 
        .total-fila{font-weight:700;text-align:right}
        
        .totales{float:right;width:300px;margin-top:20px; font-size: 14px;}
        .firmas{clear:both;margin-top:120px;display:flex;justify-content:space-between;text-align:center;color:#555; font-size: 14px;} 
        
        .totales-item{display:flex;justify-content:space-between;padding:6px 0}
        .totales-item.total-general{border-top:2px solid #333;padding-top:10px;color:var(--azul);font-size:18px}
        .firmas div{width:45%}
        .firmas span{display:block;border-top:1px solid #999;margin-bottom:6px;padding-top:6px}
        .footer{clear:both;padding-top:36px;border-top:1px solid #eee;text-align:center;color:#777;font-size:11px}
        
        @media print{
            .controles{display:none}
            .cotizacion-container{box-shadow:none;border:none}
        }

        /* =============================================
        ðŸ›‘ ESTILOS PARA LA GENERACIÃ“N DEL PDF
        =============================================
        */
        
        body.generando-pdf .cotizacion-container {
            border: none;
            box-shadow: none;
            min-height: 0 !important; 
        }

        /* ðŸš€ CORRECCIÃ“N: Quitar cajas y reducir espacio en Info Cliente/CotizaciÃ³n */
        body.generando-pdf .info-section {
            gap: 20px !important; 
            margin-top: 20px !important;
        }
        body.generando-pdf .info-section > div {
            border: none !important;
            padding: 0 !important; 
        }
        body.generando-pdf .info-section h3 {
             margin-bottom: 8px !important; 
        }
        body.generando-pdf .info-item {
             margin-bottom: 2px !important; 
        }

        /* =============================================
           âœ… CORRECCIÃ“N 2: TEXTO CORTADO
           Se reemplazÃ³ el 'padding-top/bottom: 5px' (que causa el bug de corte)
           por 'line-height' y 'min-height' para dar espacio vertical al texto.
           =============================================
        */
        body.generando-pdf input,
        body.generando-pdf textarea {
            border: none !important; /* Quita el borde visual */
            background-color: transparent !important;
            box-shadow: none !important;
            color: #333 !important; 
            resize: none;
            
            /* 1. CORRECCIÃ“N TEXTO CORTADO: */
            padding-top: 0 !important; 
            padding-bottom: 0 !important;
            line-height: 1.5 !important; /* Da 'aire' vertical al texto */

            /* 2. Arregla el gap de 'DirecciÃ³n' y asegura altura mÃ­nima */
            height: auto !important; 
            min-height: 1.5em !important; /* Altura mÃ­nima basada en font-size */
        }

        /* Re-aplicar padding horizontal original */
        body.generando-pdf .info-item input,
        body.generando-pdf .info-item textarea {
            padding-left: 6px !important;
            padding-right: 6px !important;
        }
         body.generando-pdf #tabla-items input {
            padding-left: 4px !important;
            padding-right: 4px !important;
        }


        body.generando-pdf .btn-peligro {
            display: none !important;
        }
        
        /* Compactar tabla */
        body.generando-pdf #tabla-items th,
        body.generando-pdf #tabla-items td {
            padding-top: 4px !important;
            padding-bottom: 4px !important;
        }

        /* Ocultar la Ãºltima columna (botÃ³n 'X') */
        body.generando-pdf #tabla-items th:last-child,
        body.generando-pdf #tabla-items td:last-child {
            display: none !important;
        }

        /* Redistribuir el ancho de las columnas */
        body.generando-pdf #tabla-items th:nth-child(1) { width: 10% !important; }
        body.generando-pdf #tabla-items td:nth-child(1) { width: 10% !important; }
        body.generando-pdf #tabla-items th:nth-child(2) { width: 60% !important; }
        body.generando-pdf #tabla-items td:nth-child(2) { width: 60% !important; }
        body.generando-pdf #tabla-items th:nth-child(3) { width: 15% !important; }
        body.generando-pdf #tabla-items td:nth-child(3) { width: 15% !important; }
        body.generando-pdf #tabla-items th:nth-child(4) { width: 15% !important; }
        body.generando-pdf #tabla-items td:nth-child(4) { width: 15% !important; }


        body.generando-pdf .totales {
            margin-top: 20px !important; 
        }

        /* ðŸš€ CORRECCIÃ“N: Margen obligatorio para sellos y firmas */
        body.generando-pdf .firmas {
            margin-top: 240px !important; /* MÃ¡s del doble del original (120px) */
        }

        body.generando-pdf .footer {
            padding-top: 20px !important;
        }
    </style>
</head>
<body>
    <div class="controles">
        <button id="btnAgregar" class="btn btn-secundario" type="button">+ Agregar Fila</button>
        <button id="btnDescargar" class="btn" type="button">Descargar PDF</button>
    </div>

    <div id="cotizacionParaPDF" class="cotizacion-container">
        <header class="header">
            <table>
                <tr>
                    <td style="width:200px;vertical-align:top;">
                        <img id="logo-web" src="logo tu quincalla.png" alt="Logo La Quincalla de Mauriel">
                    </td>
                    <td style="vertical-align:top;">
                        <div class="empresa-info">
                            <h1>COTIZACIÃ“N</h1>
                            <p><strong>LA QUINCALLA DE MAURIEL, C.A.</strong><br>
                               RIF: J-505792989<br>
                               Sta Teresa del Tuy, Independencia, Miranda.<br>
                               TelÃ©fono: +58 0414-2738221<br>
                               Email: laquincalledemauriel@gmail.com
                            </p>
                        </div>
                    </td>
                </tr>
            </table>
        </header>
        
        <section class="info-section">
            <div>
                <h3>CLIENTE</h3>
                <div class="info-item"><label>Nombres:</label><input id="cliente-nombre" type="text" placeholder="Nombre del Cliente"></div>
                <div class="info-item"><label>RIF/CI:</label><input id="cliente-id" type="text" placeholder="RIF o CÃ©dula"></div>
                <div class="info-item"><label>TelÃ©fono:</label><input id="cliente-tel" type="text" placeholder="TelÃ©fono"></div>
                <div class="info-item"><label>DirecciÃ³n:</label><input id="cliente-dir" type="text" placeholder="DirecciÃ³n"></div>
            </div>
            <div class="cot-data">
                <h3>COTIZACIÃ“N</h3>
                <div class="info-item"><label>NÃºmero:</label><input id="cotizacion-numero" type="text" value="COT-2025-001"></div>
                <div class="info-item"><label>Fecha:</label><input id="fecha-hoy" type="date"></div>
                <div class="info-item"><label>Validez:</label><input id="validez" type="text" value="15 DÃ­as"></div>
            </div>
        </section>

        <section class="tabla-container">
            <table id="tabla-items">
                <thead>
                    <tr>
                        <th style="width:10%">CANT.</th>
                        <th style="width:52%">DESCRIPCIÃ“N</th>
                        <th style="width:14%">P. UNITARIO ($)</th>
                        <th style="width:14%">TOTAL ($)</th>
                        <th style="width:10%"></th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td><input class="cantidad" type="number" value="1" min="0" step="1"></td>
                        <td><input class="descripcion" type="text" placeholder="Describe el producto o servicio"></td>
                        <td><input class="precio" type="number" value="0.00" step="0.01" min="0"></td>
                        <td class="total-fila">0.00</td>
                        <td style="text-align:center"><button class="btn-peligro" type="button">X</button></td>
                    </tr>
                </tbody>
            </table>
        </section>

        <section class="totales">
            <div class="totales-item"><label>Subtotal:</label><span id="subtotal">0.00</span></div>
            <div class="totales-item"><label>IVA (<input id="iva-porc" type="number" value="16" min="0" style="width:60px">%):</label><span id="iva-monto">0.00</span></div>
            <div class="totales-item total-general"><label>TOTAL ($):</label><span id="total-general">0.00</span></div>
        </section>

        <div class="firmas">
            <div><span></span>De Recibido por el Cliente</div>
            <div><span></span>Firma y Sello de la Empresa</div>
        </div>

        <footer class="footer">
            <p><strong>GRACIAS POR SU CONFIANZA</strong></p>
            <p>TÃ©rminos: Precios Sujetos a Cambios sin Previo Aviso</p>
        </footer>
    </div>
    
    <script>
        // --- JAVASCRIPT (Sin cambios) ---
        
        // InicializaciÃ³n y manejo de la interfaz
        document.getElementById('fecha-hoy').valueAsDate = new Date();
        const $tablaBody = document.querySelector('#tabla-items tbody');
        const btnAgregar = document.getElementById('btnAgregar');
        const btnDescargar = document.getElementById('btnDescargar');
        const ivaPorcInput = document.getElementById('iva-porc');

        $tablaBody.addEventListener('click', e => {
            if (e.target.matches('.btn-peligro')) {
                e.target.closest('tr').remove();
                calcularTotales();
            }
        });
        $tablaBody.addEventListener('input', e => {
            if (e.target.matches('.cantidad') || e.target.matches('.precio')) calcularTotales();
        });
        ivaPorcInput.addEventListener('input', calcularTotales);

        btnAgregar.addEventListener('click', () => {
            const tr = document.createElement('tr');
            tr.innerHTML = `
                <td><input class="cantidad" type="number" value="1" min="0" step="1"></td>
                <td><input class="descripcion" type="text" placeholder="Describe el producto o servicio"></td>
                <td><input class="precio" type="number" value="0.00" step="0.01" min="0"></td>
                <td class="total-fila">0.00</td>
                <td style="text-align:center"><button class="btn-peligro" type="button">X</button></td>
            `;
            $tablaBody.appendChild(tr);
            calcularTotales();
        });

        function calcularTotales() {
            let subtotal = 0;
            document.querySelectorAll('#tabla-items tbody tr').forEach(fila => {
                const cantidad = parseFloat(fila.querySelector('.cantidad').value) || 0;
                const precio = parseFloat(fila.querySelector('.precio').value) || 0;
                const totalFila = cantidad * precio;
                fila.querySelector('.total-fila').textContent = totalFila.toFixed(2);
                subtotal += totalFila;
            });
            const ivaPorc = parseFloat(document.getElementById('iva-porc').value) || 0;
            const ivaMonto = subtotal * (ivaPorc / 100);
            const total = subtotal + ivaMonto;
            document.getElementById('subtotal').textContent = subtotal.toFixed(2);
            document.getElementById('iva-monto').textContent = ivaMonto.toFixed(2);
            document.getElementById('total-general').textContent = total.toFixed(2);
        }

        // LÃ³gica de GeneraciÃ³n de PDF (html2canvas)
        async function descargarPDF() {
            btnDescargar.disabled = true;
            btnDescargar.textContent = 'Generando PDF...';

            // 1. AÃ±adimos la clase al body
            document.body.classList.add('generando-pdf');

            try {
                // 2. Obtener el elemento a convertir
                const cotizacionElement = document.getElementById('cotizacionParaPDF');
                
                // 3. Inicializar jsPDF
                const { jsPDF } = window.jspdf;
                const doc = new jsPDF({
                    orientation: 'portrait',
                    unit: 'pt',
                    format: 'letter'
                });

                // 4. Definir mÃ¡rgenes y dimensiones
                const margin = 36;
                const pdfWidth = doc.internal.pageSize.getWidth() - (margin * 2);
                const pdfPageHeight = doc.internal.pageSize.getHeight() - (margin * 2);

                // 5. Usar html2canvas
                const canvas = await html2canvas(cotizacionElement, {
                    scale: 2, 
                    useCORS: true,
                    width: cotizacionElement.scrollWidth, 
                    height: cotizacionElement.scrollHeight,
                    backgroundColor: '#ffffff'
                });

                const imgData = canvas.toDataURL('image/png');
                const imgWidth = pdfWidth;
                const imgHeight = (canvas.height * imgWidth) / canvas.width;
                let heightLeft = imgHeight;
                let position = margin; 

                // 6. AÃ±adir imagen al PDF (con paginaciÃ³n)
                doc.addImage(imgData, 'PNG', margin, position, imgWidth, imgHeight);
                heightLeft -= pdfPageHeight;

                // Si heightLeft > 0, significa que el contenido es mÃ¡s largo que una pÃ¡gina
                while (heightLeft > 0) {
                    position = margin - heightLeft;
                    doc.addPage();
                    doc.addImage(imgData, 'PNG', margin, position, imgWidth, imgHeight);
                    heightLeft -= pdfPageHeight;
                }
                
                // 7. Generar nombre de archivo y guardar
                const cotNum = (document.getElementById('cotizacion-numero')?.value || 'SinNumero').trim();
                const cliente = (document.getElementById('cliente-nombre')?.value || 'Cliente').trim().replace(/\s+/g,'-');
                const fileName = `Cotizacion-${cotNum}-${cliente}.pdf`;

                doc.save(fileName); 

            } catch (error) {
                console.error("Error al generar el PDF con html2canvas:", error);
                alert("Hubo un error al generar el PDF. Revisa la consola para mÃ¡s detalles.");
            } finally {
                // 8. Quitar la clase y reestablecer el botÃ³n
                document.body.classList.remove('generando-pdf');
                btnDescargar.disabled = false;
                btnDescargar.textContent = 'Descargar PDF';
            }
        }

        btnDescargar.addEventListener('click', () => {
             calcularTotales(); 
             descargarPDF();  
        });

        calcularTotales();
    </script>
</body>
</html>